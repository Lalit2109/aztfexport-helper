# Azure DevOps Pipeline for Terraform Export
# Exports Azure resources using aztfexport and pushes to git repositories

trigger:
  - main
  - master

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'TerraformExport'  # Variable group with configuration
  - name: configPath
    value: 'config/subscriptions.yaml'
  - name: outputDir
    value: '$(Pipeline.Workspace)/exports'
  - name: gitBranch
    value: 'main'
  - name: pushToRepos
    value: 'true'  # Set to 'false' to disable git push

steps:
  # Step 1: Install prerequisites
  - task: GoTool@0
    displayName: 'Install Go (for aztfexport)'
    inputs:
      version: '1.21.x'

  - script: |
      echo "Installing aztfexport..."
      go install github.com/Azure/aztfexport@latest
      export PATH=$PATH:$(go env GOPATH)/bin
      aztfexport --version
      echo "##vso[task.prependpath]$(go env GOPATH)/bin"
    displayName: 'Install aztfexport'

  - task: UsePythonVersion@0
    displayName: 'Setup Python'
    inputs:
      versionSpec: '3.10'
      addToPath: true

  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install Python dependencies'

  # Step 2: Configure Azure authentication using service connection
  - task: AzureCLI@2
    displayName: 'Azure Login via Service Connection'
    inputs:
      azureSubscription: '$(azureServiceConnection)'  # Service connection name from variable group
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Authenticating with Azure..."
        az account show
        echo "##vso[task.setvariable variable=AZURE_SUBSCRIPTION_ID]$(az account show --query id -o tsv)"
        echo "Logged in to subscription: $(az account show --query name -o tsv)"

  # Step 3: Configure Git
  - script: |
      git config --global user.name "Azure Pipelines"
      git config --global user.email "azure-pipelines@devops.com"
    displayName: 'Configure Git'

  # Step 4: Set up Azure DevOps authentication for git operations
  # SYSTEM_ACCESS_TOKEN is automatically available in Azure DevOps pipelines
  - script: |
      echo "Setting up Azure DevOps authentication..."
      echo "##vso[task.setvariable variable=AZURE_DEVOPS_PAT]$(System.AccessToken)"
    displayName: 'Setup Azure DevOps Token'
    env:
      SYSTEM_ACCESS_TOKEN: $(System.AccessToken)

  # Step 5: Run export
  - script: |
      echo "Starting Terraform export..."
      export PUSH_TO_REPOS=$(pushToRepos)
      export GIT_BRANCH=$(gitBranch)
      export OUTPUT_DIR=$(outputDir)
      export LOG_LEVEL=INFO
      python src/main.py
    displayName: 'Export Azure Resources to Terraform'
    env:
      SYSTEM_ACCESS_TOKEN: $(System.AccessToken)
      AZURE_DEVOPS_PAT: $(System.AccessToken)
      CONFIG_PATH: $(configPath)

  # Step 6: Publish export results as artifacts
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Export Results'
    inputs:
      pathToPublish: '$(outputDir)'
      artifactName: 'terraform-exports'
      publishLocation: 'Container'
    condition: always()

  # Step 7: Generate summary report
  - script: |
      if [ -f "$(outputDir)/export_results.json" ]; then
        echo "##vso[task.logissue type=command]##[section]Export Summary"
        echo "```json"
        cat $(outputDir)/export_results.json | python -m json.tool
        echo "```"
      else
        echo "Export results file not found"
      fi
    displayName: 'Generate Summary Report'
    continueOnError: true

