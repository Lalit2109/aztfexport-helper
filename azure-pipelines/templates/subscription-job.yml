# Template for a single subscription export job
# Can be reused to create parallel jobs for multiple subscriptions

parameters:
  - name: subscriptionId
    type: string
  - name: subscriptionName
    type: string
    default: ''
  - name: serviceConnection
    type: string
    default: '$(azureServiceConnection)'
  - name: configPath
    type: string
    default: 'config/subscriptions.yaml'
  - name: outputDir
    type: string
    default: '$(Pipeline.Workspace)/exports'
  - name: gitBranch
    type: string
    default: 'main'
  - name: pushToRepos
    type: string
    default: 'true'

jobs:
  - job: Export_${{ replace(parameters.subscriptionId, '-', '_') }}
    displayName: 'Export ${{ parameters.subscriptionName }} (${{ parameters.subscriptionId }})'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: GoTool@0
        displayName: 'Install Go (for aztfexport)'
        inputs:
          version: '1.21.x'

      - script: |
          echo "Installing aztfexport..."
          go install github.com/Azure/aztfexport@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          aztfexport --version
          echo "##vso[task.prependpath]$(go env GOPATH)/bin"
        displayName: 'Install aztfexport'

      - task: UsePythonVersion@0
        displayName: 'Setup Python'
        inputs:
          versionSpec: '3.10'
          addToPath: true

      - script: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        displayName: 'Install Python dependencies'

      - task: TerraformInstaller@0
        displayName: 'Install Terraform'
        inputs:
          terraformVersion: 'latest'

      - script: |
          echo "Cleaning output directory: ${{ parameters.outputDir }}"
          if [ -d "${{ parameters.outputDir }}" ]; then
            rm -rf "${{ parameters.outputDir }}"
          fi
          mkdir -p "${{ parameters.outputDir }}"
        displayName: 'Clean export/output directory'

      - task: AzureCLI@2
        displayName: 'Azure Login and Export'
        inputs:
          azureSubscription: '${{ parameters.serviceConnection }}'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            echo "Authenticating with Azure..."
            az account set --subscription ${{ parameters.subscriptionId }}
            az account show
            
            echo "##vso[task.setvariable variable=AZURE_SUBSCRIPTION_ID]${{ parameters.subscriptionId }}"
            echo "Logged in to subscription: $(az account show --query name -o tsv)"
            
            git config --global user.name "Azure Pipelines"
            git config --global user.email "azure-pipelines@devops.com"
            
            export PUSH_TO_REPOS=${{ parameters.pushToRepos }}
            export GIT_BRANCH=${{ parameters.gitBranch }}
            export OUTPUT_DIR=${{ parameters.outputDir }}
            export LOG_LEVEL=INFO
            export CONFIG_PATH=${{ parameters.configPath }}
            export SUBSCRIPTION_ID=${{ parameters.subscriptionId }}
            export SUBSCRIPTION_NAME=${{ coalesce(parameters.subscriptionName, parameters.subscriptionId) }}
            export AZURE_DEVOPS_PAT=$(System.AccessToken)
            export SYSTEM_ACCESS_TOKEN=$(System.AccessToken)
            export LOG_ANALYTICS_WORKSPACE_ID=$(LOG_ANALYTICS_WORKSPACE_ID)
            export LOG_ANALYTICS_SHARED_KEY=$(LOG_ANALYTICS_SHARED_KEY)
            
            echo "Starting Terraform export for subscription: ${{ coalesce(parameters.subscriptionName, parameters.subscriptionId) }}"
            python src/main.py
        env:
          SYSTEM_ACCESS_TOKEN: $(System.AccessToken)
          LOG_ANALYTICS_WORKSPACE_ID: $(LOG_ANALYTICS_WORKSPACE_ID)
          LOG_ANALYTICS_SHARED_KEY: $(LOG_ANALYTICS_SHARED_KEY)

      - script: |
          if [ ! -d "${{ parameters.outputDir }}" ]; then
            echo "No export output directory found. Export may have failed."
            exit 1
          fi
          
          if [ -z "$(ls -A ${{ parameters.outputDir }})" ]; then
            echo "Export directory is empty. No resources exported."
            exit 1
          fi
          
          echo "Export completed successfully"
          ls -la "${{ parameters.outputDir }}"
        displayName: 'Verify Export Output'
        continueOnError: true

      - task: PublishPipelineArtifact@1
        displayName: 'Publish Export Artifacts'
        inputs:
          targetPath: ${{ parameters.outputDir }}
          artifactName: terraform-export-${{ replace(parameters.subscriptionId, '-', '_') }}
          publishLocation: 'pipeline'
        condition: succeededOrFailed()
        continueOnError: true

