parameters:
  - name: serviceConnection
    type: string
  - name: subscriptionIds
    type: object
  - name: outputDir
    type: string
  - name: configPath
    type: string
  - name: defaultServiceConnection
    type: string

jobs:
- job: ExportJob_${{ replace(parameters.serviceConnection, '-', '_') }}
  displayName: 'Export via ${{ parameters.serviceConnection }}'
  pool:
    vmImage: 'ubuntu-latest'
  steps:
    - task: GoTool@0
      displayName: 'Install Go (for aztfexport)'
      inputs:
        version: '1.21.x'

    - script: |
        echo "Installing aztfexport..."
        go install github.com/Azure/aztfexport@latest
        export PATH=$PATH:$(go env GOPATH)/bin
        aztfexport --version
        echo "##vso[task.prependpath]$(go env GOPATH)/bin"
      displayName: 'Install aztfexport'

    - task: UsePythonVersion@0
      displayName: 'Setup Python'
      inputs:
        versionSpec: '3.10'
        addToPath: true

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install Python dependencies'

    - task: TerraformInstaller@0
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'

    - script: |
        echo "Cleaning output directory: ${{ parameters.outputDir }}"
        if [ -d "${{ parameters.outputDir }}" ]; then
          rm -rf "${{ parameters.outputDir }}"
        fi
        mkdir -p "${{ parameters.outputDir }}"
        echo "Output directory is now clean:"
        ls -la "${{ parameters.outputDir }}" || echo "Directory is empty"
      displayName: 'Clean export/output directory'

    - task: AzureCLI@2
      displayName: 'Azure Login and Export'
      inputs:
        # CRITICAL: Use default SPN for authentication (compile-time resolution)
        # The serviceConnection parameter is for reference/logging only
        azureSubscription: '${{ parameters.defaultServiceConnection }}'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Authenticating with Azure..."
          az account show
          echo "##vso[task.setvariable variable=AZURE_SUBSCRIPTION_ID]$(az account show --query id -o tsv)"
          echo "Logged in to subscription: $(az account show --query name -o tsv)"
          echo "Service connection (reference): ${{ parameters.serviceConnection }}"
          
          # Verify Terraform is available
          echo "Checking Terraform installation..."
          terraform --version || echo "Warning: Terraform not found in PATH"
          which terraform || echo "Warning: terraform command not found"
          
          # Configure Git
          git config --global user.name "Azure Pipelines"
          git config --global user.email "azure-pipelines@devops.com"
          
          # Convert subscriptionIds array to JSON string
          SUBSCRIPTIONS_JSON=$(echo '${{ convertToJson(parameters.subscriptionIds) }}')
          
          # Set up environment variables
          export PUSH_TO_REPOS=$(pushToRepos)
          export GIT_BRANCH=$(gitBranch)
          export OUTPUT_DIR="${{ parameters.outputDir }}"
          export LOG_LEVEL=INFO
          export CONFIG_PATH="${{ parameters.configPath }}"
          export EXPORT_SUBSCRIPTIONS="$SUBSCRIPTIONS_JSON"
          export AZURE_DEVOPS_PAT=$(System.AccessToken)
          export SYSTEM_ACCESS_TOKEN=$(System.AccessToken)
          export LOG_ANALYTICS_WORKSPACE_ID=$(LOG_ANALYTICS_WORKSPACE_ID)
          export LOG_ANALYTICS_SHARED_KEY=$(LOG_ANALYTICS_SHARED_KEY)
          
          # Run export
          echo "Starting Terraform export..."
          echo "Exporting subscriptions: $SUBSCRIPTIONS_JSON"
          python src/main.py
      env:
        SYSTEM_ACCESS_TOKEN: $(System.AccessToken)
        LOG_ANALYTICS_WORKSPACE_ID: $(LOG_ANALYTICS_WORKSPACE_ID)
        LOG_ANALYTICS_SHARED_KEY: $(LOG_ANALYTICS_SHARED_KEY)

    - script: |
        # Ensure output directory exists
        if [ ! -d "${{ parameters.outputDir }}" ]; then
          echo "Creating output directory: ${{ parameters.outputDir }}"
          mkdir -p "${{ parameters.outputDir }}"
        fi
        # Check if directory has content
        if [ -z "$(ls -A ${{ parameters.outputDir }} 2>/dev/null)" ]; then
          echo "Warning: Output directory is empty, creating placeholder"
          echo "No exports completed" > "${{ parameters.outputDir }}/README.txt"
        fi
        echo "Output directory contents:"
        ls -la "${{ parameters.outputDir }}" || echo "Directory is empty"
      displayName: 'Prepare Output Directory'
      continueOnError: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Export Results'
      inputs:
        pathToPublish: '${{ parameters.outputDir }}'
        artifactName: 'terraform-exports-${{ replace(parameters.serviceConnection, '-', '_') }}'
        publishLocation: 'Container'
      condition: always()

    - script: |
        if [ -f "${{ parameters.outputDir }}/export_results.json" ]; then
          echo "##[section]Export Summary"
          echo '```json'
          cat "${{ parameters.outputDir }}/export_results.json" | python -m json.tool
          echo '```'
        else
          echo "Export results file not found"
        fi
      displayName: 'Generate Summary Report'
      continueOnError: true

