# Azure DevOps Pipeline for Terraform Export
# Exports Azure resources using aztfexport and pushes to git repositories
# Uses matrix strategy with maxParallel to limit concurrent jobs

trigger: none
pr: none

parameters:
  - name: subscriptionIds
    displayName: 'Subscription IDs (comma-separated) - Reference only'
    type: string
    default: ''
    # Note: This parameter is for reference only
    # Jobs must be manually defined in the matrix below

variables:
  - group: 'TerraformExport'
  - name: configPath
    value: 'config/subscriptions.yaml'
  - name: outputDir
    value: '$(Pipeline.Workspace)/exports'
  - name: gitBranch
    value: 'main'
  - name: pushToRepos
    value: 'true'

stages:
  - stage: Export
    displayName: 'Terraform Export'
    pool:
      vmImage: 'ubuntu-latest'
    jobs:
      - job: ExportJob
        displayName: 'Export Azure Resources'
        strategy:
          matrix:
            # Add all your subscriptions here
            # Format: subscription-key (used for job name)
            #   subscription_id: 'actual-subscription-id'
            #   subscription_name: 'Display Name'
            # Note: All subscriptions use the default service connection from variable group
            # To use different service connections, you'll need separate jobs (not matrix)
            
            # Example subscriptions (replace with your 35 subscriptions):
            sub1:
              subscription_id: 'sub-123'
              subscription_name: 'Production Subscription 1'
            
            sub2:
              subscription_id: 'sub-456'
              subscription_name: 'Production Subscription 2'
            
            # Add remaining 33 subscriptions here...
            # sub3:
            #   subscription_id: 'sub-789'
            #   subscription_name: 'Production Subscription 3'
            # ... (up to sub35)
          maxParallel: 4  # â† Limits to 4 concurrent jobs (only 4 will run at a time)
        steps:
          - template: azure-pipelines/templates/subscription-steps.yml
            parameters:
              subscriptionId: $(subscription_id)
              subscriptionName: $(subscription_name)
              serviceConnection: '$(azureServiceConnection)'  # All use default service connection
              configPath: $(configPath)
              outputDir: $(outputDir)
              gitBranch: $(gitBranch)
              pushToRepos: $(pushToRepos)

  - stage: EmailReport
    displayName: 'Send Email Report'
    dependsOn: Export
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: EmailReportJob
        displayName: 'Send Email Report'
        steps:
          - task: AzurePowerShell@5
            displayName: 'Send Terraform Backup Email Report'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              ScriptType: 'FilePath'
              ScriptPath: 'azure-pipelines/scripts/send-backup-report.ps1'
              ScriptArguments: >
                -LogAnalyticsWorkspaceId "$(LOG_ANALYTICS_WORKSPACE_ID)"
                -LogAnalyticsSharedKey "$(LOG_ANALYTICS_SHARED_KEY)"
                -SendGridApiKey "$(SendGridApiKey)"
                -SendGridFrom "$(SendGridFrom)"
                -SendGridTo "$(SendGridTo)"
                -EnvName "$(Environment)"
                -LookbackHours 24
              azurePowerShellVersion: 'LatestVersion'
            continueOnError: true
